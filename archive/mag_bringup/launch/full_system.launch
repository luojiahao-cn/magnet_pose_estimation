<launch>
  <!-- 完整磁场扫描系统：传感器 + 机械臂扫描 + 实时可视化 -->

  <!-- 参数配置 -->
  <arg name="use_gazebo" default="false" />
  <arg name="move_group_output" default="log"/>
  <arg name="use_attached_tool" default="true" />
  <arg name="start_rviz" default="true" />
  <arg name="use_sim_sensor" default="false" />

  <!-- 1) MoveIt 与机械臂环境 -->
  <group if="$(arg use_gazebo)">
    <include file="$(find fr5v6_single_moveit_config)/launch/demo_gazebo.launch">
      <arg name="move_group_output" value="$(arg move_group_output)"/>
    </include>
  </group>
  <group unless="$(arg use_gazebo)">
    <include file="$(find frcobot_examples)/launch/connect_single_arm.launch">
      <arg name="move_group_output" value="$(arg move_group_output)"/>
      <arg name="use_rviz" value="false" /> 
    </include>
  </group>

  <!-- 2) 工具支架管理 -->
  <group if="$(arg use_attached_tool)">
    <node pkg="mag_arm_scan" type="tool_manager_node" name="tool_manager" output="screen">
      <rosparam file="$(find mag_arm_scan)/config/scan_tool.yaml" command="load" />
    </node>
  </group>

  <!-- 3) 磁传感器节点 -->
  <group if="$(arg use_sim_sensor)">
    <param name="/use_sim_time" value="true" />
    <node pkg="mag_sensor_node" type="mag_sensor_sim_node" name="mag_sensor" output="screen">
      <rosparam file="$(find mag_sensor_node)/config/sensor_array.yaml" command="load" />
      <rosparam file="$(find mag_sensor_node)/config/mag_sensor_sim_node.yaml" command="load" />
    </node>
  </group>
  <group unless="$(arg use_sim_sensor)">
    <node pkg="mag_sensor_node" type="mag_sensor_node" name="mag_sensor" output="screen">
      <rosparam file="$(find mag_sensor_node)/config/sensor_array.yaml" command="load" />
      <rosparam file="$(find mag_sensor_node)/config/mag_sensor_node.yaml" command="load" />
    </node>
  </group>

  <!-- 4) 传感器 TF 发布器 -->
  <node pkg="mag_sensor_node" type="sensor_tf_publisher_node" name="sensor_tf_publisher" output="screen">
    <rosparam file="$(find mag_sensor_node)/config/sensor_array.yaml" command="load" />
  </node>

  <!-- 5) 扫描控制与记录 -->
  <node pkg="mag_arm_scan" type="scan_controller_with_recorder_node" name="scan_controller_with_recorder" output="screen">
    <rosparam file="$(find mag_sensor_node)/config/sensor_array.yaml" command="load" />
    <rosparam file="$(find mag_arm_scan)/config/scan_controller_node.yaml" command="load" />
  </node>

  <!-- 6) 实时磁场可视化 -->
  <!-- 移除 field_map_aggregator，由 scan_controller_with_recorder 完成 -->

  <!-- 7) RViz 可视化界面 -->
  <group if="$(arg start_rviz)">
    <node name="rviz" pkg="rviz" type="rviz" args="-d $(find mag_viz)/rviz/mag_sensor.rviz" />
    <node name="rviz_arm" pkg="rviz" type="rviz" args="-d $(find mag_arm_scan)/rviz/mag_arm_scan.rviz" />
  </group>

</launch>