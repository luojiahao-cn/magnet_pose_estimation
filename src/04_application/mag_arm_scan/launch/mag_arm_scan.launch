<?xml version="1.0"?>
<launch>
    <!--
        扫描应用主启动文件

        开关说明：
            - use_gazebo: 是否使用 Gazebo 仿真机械臂和磁铁
            - use_real_sensor: 是否使用真实磁传感器（否则使用仿真传感器）

        约定：
            - 真实传感器和仿真传感器都发布到 /magnetic/sensor/field
            - 仿真与实物各自有独立的驱动 config（simulation.yaml / hardware.yaml）
    -->

    <!-- 是否使用 Gazebo 仿真机械臂 + 环境 -->
    <arg name="use_gazebo" default="true" />

    <!-- 是否使用真实磁传感器（true=硬件，false=仿真） -->
    <arg name="use_real_sensor" default="false" />

    <!-- MoveIt 日志输出位置：log 或 screen -->
    <arg name="move_group_output" default="log" />

    <!-- 日志级别：DEBUG, INFO, WARN, ERROR, FATAL -->
    <arg name="log_level" default="DEBUG" />

    <!-- 工具名称（末端执行器 / 传感器支架） -->
    <arg name="tool_name" default="magnetic_sensor_bracket" />

    <!-- 是否启动 RViz -->
    <arg name="use_rviz" default="true" />

    <!--
        机械臂 + MoveIt 启动：
            - use_gazebo:=true  -> 使用 single_arm_gazebo.launch
            - use_gazebo:=false -> 使用 single_arm_bringup.launch（真实机械臂）
    -->
    <group if="$(arg use_gazebo)">
        <include file="$(find mag_device_arm)/launch/single_arm_gazebo.launch">
            <arg name="tool_name" value="$(arg tool_name)" />
            <!-- 由本文件单独启动 arm_node -->
            <arg name="start_arm_node" value="false" />
        </include>

        <!-- RViz 配置（Gazebo 模式下） -->
        <group if="$(arg use_rviz)">
            <node name="rviz" pkg="rviz" type="rviz"
                        args="-d $(find mag_arm_scan)/rviz/mag_arm_scan.rviz" />
        </group>
    </group>

    <group unless="$(arg use_gazebo)">
        <include file="$(find mag_device_arm)/launch/single_arm_bringup.launch">
            <arg name="tool_name" value="$(arg tool_name)" />
            <!-- 由本文件单独启动 arm_node -->
            <arg name="start_arm_node" value="false" />
        </include>

        <!-- RViz 配置（真实机械臂模式下） -->
        <group if="$(arg use_rviz)">
            <node name="rviz" pkg="rviz" type="rviz"
                        args="-d $(find mag_arm_scan)/rviz/mag_arm_scan.rviz" />
        </group>
    </group>

    <!-- 机械臂控制节点：提供扫描控制所需的基础服务 -->
    <node pkg="mag_device_arm" type="arm_node" name="mag_device_arm" output="screen">
        <rosparam file="$(find mag_arm_scan)/config/arm_config.yaml" command="load" />
    </node>

    <!-- 磁铁真值节点（仅在 Gazebo 模式下启动，用于仿真场景） -->
    <group if="$(arg use_gazebo)">
        <node pkg="mag_device_magnet" type="magnet_main" name="mag_device_magnet" output="screen">
            <rosparam file="$(find mag_arm_scan)/config/magnet_config.yaml" command="load" />
        </node>
    </group>

    <!--
        传感器数据来源（统一通过子 launch）：
            - use_real_sensor:=true  -> include hardware.launch，使用真实硬件（hardware.yaml）
            - use_real_sensor:=false -> include simulation.launch，使用仿真传感器（simulation.yaml）

        两种模式都保证输出磁场话题：/magnetic/sensor/field
        二者共享同一个传感器阵列描述：mag_arm_scan/config/sensor_array.yaml
    -->

    <!-- 仿真传感器：simulation.launch（与 Gazebo 解耦，只要不用真实传感器就启动） -->
    <group unless="$(arg use_real_sensor)">
        <include file="$(find mag_device_sensor)/launch/simulation.launch">
            <!-- 统一使用扫描应用里的传感器阵列描述 -->
            <arg name="array_file" value="$(find mag_arm_scan)/config/sensor_array.yaml" />
            <!-- config_file / batcher_config 使用 simulation.launch 自己的默认（simulation.yaml / sensor_batcher_config.yaml） -->
        </include>
    </group>

    <!-- 真实传感器：hardware.launch -->
    <group if="$(arg use_real_sensor)">
        <include file="$(find mag_device_sensor)/launch/hardware.launch">
            <!-- 统一使用扫描应用里的传感器阵列描述 -->
            <arg name="array_file" value="$(find mag_arm_scan)/config/sensor_array.yaml" />
            <!-- config_file / batcher_config 使用 hardware.launch 自己的默认（hardware.yaml / sensor_batcher_config.yaml） -->
        </include>
    </group>

    <!-- 扫描控制节点 -->
    <!-- 订阅单个传感器数据（MagSensorData）并驱动机械臂进行扫描 -->
    <node pkg="mag_arm_scan" type="scan_controller_node" name="scan_controller" output="screen">
        <!-- 方式1：通过环境变量设置日志级别（全局，优先级较低） -->
        <env name="ROSCONSOLE_MIN_SEVERITY" value="$(arg log_level)" />

        <!-- 方式2：通过 rosparam 设置节点级日志级别（优先级更高） -->
        <rosparam param="logging_level">$(arg log_level)</rosparam>

        <!-- 加载扫描控制与传感器阵列配置 -->
        <rosparam file="$(find mag_arm_scan)/config/sensor_array.yaml" command="load" />
        <rosparam file="$(find mag_arm_scan)/config/scan_controller_node.yaml" command="load" />

        <!-- 显式指定传感器磁场话题（真实 / 仿真均保持一致） -->
        <rosparam param="config/topics/mag_field">/magnetic/sensor/field</rosparam>
    </node>

    <!-- 传感器阵列实时可视化节点：实时显示传感器磁场数据 -->
    <node pkg="mag_viz" type="sensor_array_viz_node" name="sensor_array_viz" output="screen">
        <rosparam file="$(find mag_arm_scan)/config/sensor_array.yaml" command="load" ns="array" />
        <rosparam file="$(find mag_viz)/config/sensor_array_viz.yaml" command="load" />

        <!-- 测量话题统一为 /magnetic/sensor/field（真实 / 仿真一致） -->
        <rosparam param="config/topics/measurement">/magnetic/sensor/field</rosparam>

        <!-- 固定坐标系 -->
        <rosparam param="config/frames/fixed_frame">world</rosparam>
    </node>

</launch>