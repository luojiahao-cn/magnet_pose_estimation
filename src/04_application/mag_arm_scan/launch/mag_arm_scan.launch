<launch>
    <!-- 参数：是否使用Gazebo仿真 -->
    <arg name="use_gazebo" default="true" />
    <!-- 参数：MoveIt日志输出位置，默认为log，可选screen -->
    <arg name="move_group_output" default="log"/>
    <!-- 参数：日志级别，可选值：DEBUG, INFO, WARN, ERROR, FATAL -->
    <!-- DEBUG: 显示所有日志（最详细） -->
    <!-- INFO: 显示INFO及以上级别（默认） -->
    <!-- WARN: 只显示警告和错误 -->
    <!-- ERROR: 只显示错误 -->
    <!-- FATAL: 只显示致命错误 -->
    <arg name="log_level" default="DEBUG" />

    <!-- 工具名称 -->
    <arg name="tool_name" default="magnetic_sensor_bracket" />
    <!-- 是否启动 RViz -->
    <arg name="use_rviz" default="true" />

    <!-- 根据参数选择不同的MoveIt配置 -->
    <group if="$(arg use_gazebo)">
        <!-- 使用 mag_device_arm 的 Gazebo + MoveIt 启动文件 -->
        <include file="$(find mag_device_arm)/launch/single_arm_gazebo.launch">
            <arg name="tool_name" value="$(arg tool_name)" />
        </include>
        
        <!-- Start RViz with our custom config -->
        <group if="$(arg use_rviz)">
            <node name="rviz" pkg="rviz" type="rviz" args="-d $(find mag_arm_scan)/rviz/mag_arm_scan.rviz" />
        </group>
    </group>

    <group unless="$(arg use_gazebo)">
        <!-- 使用新的 zlab_arm_bringup 启动硬件接口和 MoveIt -->
        <include file="$(find mag_device_arm)/launch/single_arm_bringup.launch">
            <arg name="tool_name" value="$(arg tool_name)" />
        </include>

        <!-- Start RViz with our custom config -->
        <group if="$(arg use_rviz)">
            <node name="rviz" pkg="rviz" type="rviz" args="-d $(find mag_arm_scan)/rviz/mag_arm_scan.rviz" />
        </group>
    </group>

    <!-- mag_device_arm 节点：提供机械臂控制服务 -->
    <node pkg="mag_device_arm" type="arm_node" name="mag_device_arm" output="screen">
        <rosparam file="$(find mag_arm_scan)/config/arm_config.yaml" command="load" />
    </node>

    <!-- 磁铁节点（仅在 Gazebo 模式下启动）：生成磁铁 TF 和真值数据 -->
    <group if="$(arg use_gazebo)">
        <node pkg="mag_device_magnet" type="magnet_main" name="mag_device_magnet" output="screen">
            <rosparam file="$(find mag_arm_scan)/config/magnet_config.yaml" command="load" />
        </node>
    </group>

    <!-- 传感器仿真节点（仅在 Gazebo 模式下启动） -->
    <group if="$(arg use_gazebo)">
        <!-- 传感器仿真节点：根据磁体 TF 生成磁传感器数据 -->
        <node pkg="mag_device_sensor" type="sensor_sim_node" name="mag_device_sensor_sim" output="screen">
            <rosparam file="$(find mag_arm_scan)/config/sensor_array.yaml" command="load" ns="array" />
            <rosparam file="$(find mag_device_sensor)/config/simulation.yaml" command="load" />
            <!-- 启用 TF 发布：发布完整的传感器阵列 TF 树 -->
            <!-- 包括 bracket_tcp_link -> sensor_array 和 sensor_array -> sensor_* -->
            <rosparam param="config/tf/enable">true</rosparam>
            <!-- 使用静态 TF 发布（publish_rate = 0），因为传感器阵列静态安装在工具上 -->
            <rosparam param="config/tf/publish_rate">0.0</rosparam>
        </node>

        <!-- 传感器批量打包节点：将单个传感器消息打包成批量数据 -->
        <node pkg="mag_device_sensor" type="sensor_array_batcher_node" name="sensor_array_batcher" output="screen">
            <rosparam file="$(find mag_device_sensor)/config/sensor_batcher_config.yaml" command="load" />
        </node>
    </group>

    <!-- 扫描控制节点 -->
    <!-- 在 Gazebo 模式下，覆盖传感器数据话题为传感器仿真节点发布的话题 -->
    <!-- 注意：scan_controller_node 订阅的是单个传感器数据（MagSensorData），不是批量数据 -->
    <group if="$(arg use_gazebo)">
        <node pkg="mag_arm_scan" type="scan_controller_node" name="scan_controller" output="screen">
            <!-- 方式1：通过环境变量设置日志级别（全局，优先级较低） -->
            <env name="ROSCONSOLE_MIN_SEVERITY" value="$(arg log_level)"/>
            <!-- 方式2：通过rosparam设置日志级别（节点级别，优先级更高，会覆盖YAML配置） -->
            <rosparam param="logging_level">$(arg log_level)</rosparam>
            <rosparam file="$(find mag_arm_scan)/config/sensor_array.yaml" command="load" />
            <rosparam file="$(find mag_arm_scan)/config/scan_controller_node.yaml" command="load" />
            <!-- 覆盖传感器数据话题：使用传感器仿真节点发布的话题 -->
            <rosparam param="config/topics/mag_field">/magnetic/sensor/field</rosparam>
        </node>
    </group>
    <group unless="$(arg use_gazebo)">
        <node pkg="mag_arm_scan" type="scan_controller_node" name="scan_controller" output="screen">
            <!-- 方式1：通过环境变量设置日志级别（全局，优先级较低） -->
            <env name="ROSCONSOLE_MIN_SEVERITY" value="$(arg log_level)"/>
            <!-- 方式2：通过rosparam设置日志级别（节点级别，优先级更高，会覆盖YAML配置） -->
            <rosparam param="logging_level">$(arg log_level)</rosparam>
            <rosparam file="$(find mag_arm_scan)/config/sensor_array.yaml" command="load" />
            <rosparam file="$(find mag_arm_scan)/config/scan_controller_node.yaml" command="load" />
        </node>
    </group>

    <!-- 传感器阵列实时可视化节点：实时显示传感器磁场数据 -->
    <node pkg="mag_viz" type="sensor_array_viz_node" name="sensor_array_viz" output="screen">
        <rosparam file="$(find mag_arm_scan)/config/sensor_array.yaml" command="load" ns="array" />
        <rosparam file="$(find mag_viz)/config/sensor_array_viz.yaml" command="load" />
        <!-- 覆盖测量话题：使用传感器数据话题 -->
        <rosparam param="config/topics/measurement">/magnetic/sensor/field</rosparam>
        <!-- 设置固定坐标系为 world -->
        <rosparam param="config/frames/fixed_frame">world</rosparam>
    </node>

</launch>