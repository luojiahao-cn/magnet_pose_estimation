<?xml version="1.0"?>
<launch>
  <!-- 设置日志级别为 DEBUG（可选，取消注释以启用） -->
  <!-- <env name="ROSCONSOLE_MIN_SEVERITY" value="DEBUG"/> -->
  
  <!-- 参数配置 -->
  <!-- 仿真专用配置 -->
  <arg name="magnet_config" default="$(find mag_sensor_fixture_app)/simulation/magnet_config.yaml"/>
  <arg name="sensor_sim_config" default="$(find mag_sensor_fixture_app)/simulation/sensor_sim_config.yaml"/>
  <!-- 共用配置 -->
  <arg name="sensor_array_config" default="$(find mag_core_description)/config/sensor_array.yaml"/>
  <arg name="estimator_config" default="$(find mag_sensor_fixture_app)/config/estimator_config.yaml"/>
  <arg name="viz_config" default="$(find mag_sensor_fixture_app)/config/magnet_viz_config.yaml"/>
  <arg name="sensor_viz_config" default="$(find mag_sensor_fixture_app)/config/sensor_array_viz_config.yaml"/>
  <arg name="use_rviz" default="true"/>

  <!-- 磁体设备节点：生成磁体运动轨迹和 TF -->
  <node pkg="mag_device_magnet" type="magnet_main" name="mag_device_magnet" output="screen">
    <rosparam command="load" file="$(arg magnet_config)"/>
  </node>

  <!-- 传感器仿真节点：根据 TF 生成磁传感器数据 -->
  <node pkg="mag_device_sensor" type="sensor_sim_node" name="mag_device_sensor_sim" output="screen">
    <rosparam command="load" file="$(arg sensor_array_config)" ns="array"/>
    <rosparam command="load" file="$(arg sensor_sim_config)"/>
  </node>

  <!-- 传感器批量打包节点：将单个传感器消息打包成批量数据 -->
  <node pkg="mag_device_sensor" type="sensor_array_batcher_node" name="sensor_array_batcher" output="screen">
    <rosparam command="load" file="$(find mag_sensor_fixture_app)/config/sensor_batcher_config.yaml"/>
  </node>

  <!-- 姿态估计节点：估计磁体姿态 -->
  <node pkg="mag_pose_estimator" type="mag_pose_estimator_node" name="mag_pose_estimator" output="screen">
    <rosparam command="load" file="$(arg estimator_config)"/>
  </node>

  <!-- 可视化节点：展示真值和估计结果 -->
  <node pkg="mag_viz" type="magnet_viz_node" name="magnet_viz" output="screen">
    <rosparam command="load" file="$(arg viz_config)"/>
  </node>

  <!-- 传感器阵列可视化节点 -->
  <node pkg="mag_viz" type="sensor_array_viz_node" name="sensor_array_viz" output="screen">
    <rosparam command="load" file="$(arg sensor_viz_config)"/>
    <rosparam command="load" file="$(arg sensor_array_config)" ns="array"/>
  </node>

  <!-- RViz 可视化 -->
  <group if="$(arg use_rviz)">
    <!-- 将 rviz 输出重定向到 log，不在终端显示 -->
    <node pkg="rviz" type="rviz" name="magnet_viz_rviz" 
          args="-d $(find mag_sensor_fixture_app)/rviz/magnet_viz.rviz" output="log">
      <!-- 设置 rviz 相关日志级别为 WARN，过滤 INFO 信息 -->
      <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
    </node>
  </group>
</launch>

