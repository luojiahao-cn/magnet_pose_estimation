<?xml version="1.0"?>
<launch>
  <!-- 设置全局日志级别为 WARN，减少终端输出 -->
  <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
  
  <!-- 参数配置 -->
  <arg name="sensor_array_config" default="$(find mag_single_tracking_app)/config/sensor_array.yaml"/>
  <arg name="arm_config" default="$(find mag_single_tracking_app)/config/arm_config.yaml"/>
  <arg name="magnet_config" default="$(find mag_single_tracking_app)/config/magnet_config.yaml"/>
  <arg name="sensor_sim_config" default="$(find mag_single_tracking_app)/config/sensor_sim_config.yaml"/>
  <arg name="estimator_config" default="$(find mag_single_tracking_app)/config/estimator_config.yaml"/>
  <arg name="magnet_viz_config" default="$(find mag_single_tracking_app)/config/magnet_viz_config.yaml"/>
  <arg name="sensor_array_viz_config" default="$(find mag_single_tracking_app)/config/sensor_array_viz_config.yaml"/>
  <arg name="sensor_batcher_config" default="$(find mag_single_tracking_app)/config/sensor_batcher_config.yaml"/>
  <arg name="tracking_control_config" default="$(find mag_single_tracking_app)/config/tracking_control_config.yaml"/>
  <arg name="enable_tracking_control" default="true" doc="是否启用跟踪控制（自动跟踪磁铁）"/>
  <arg name="enable_execution" default="true" doc="跟踪控制是否实际执行运动（false=仅规划，true=执行）"/>
  <arg name="use_rviz" default="true"/>

  <!-- 启动 Gazebo 和 MoveIt 配置 -->
  <include file="$(find mag_device_arm)/launch/single_arm_gazebo.launch">
    <arg name="tool_name" value="bracket" />
  </include>

  <!-- 机械臂控制节点 -->
  <node pkg="mag_device_arm" type="arm_node" name="mag_device_arm" output="screen">
    <!-- 方式1：通过环境变量设置日志级别（全局，优先级较低） -->
    <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
    <!-- 方式2：通过rosparam设置日志级别（节点级别，优先级更高，会覆盖YAML配置） -->
    <!-- <rosparam param="logging_level">DEBUG</rosparam> -->
    <rosparam command="load" file="$(arg arm_config)"/>
  </node>

  <!-- 磁体设备节点：生成磁体运动轨迹和 TF -->
  <node pkg="mag_device_magnet" type="magnet_main" name="mag_device_magnet" output="screen">
    <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
    <rosparam command="load" file="$(arg magnet_config)"/>
  </node>

  <!-- 传感器仿真节点：根据 TF 生成磁传感器数据，并发布传感器阵列的静态 TF -->
  <!-- 注意：sensor_sim_node 会发布从 bracket_tcp_link 到 sensor_array 的静态 TF（根据 sensor_array.yaml 配置） -->
  <node pkg="mag_device_sensor" type="sensor_sim_node" name="mag_device_sensor_sim" output="screen">
    <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
    <rosparam command="load" file="$(arg sensor_array_config)" ns="array"/>
    <rosparam command="load" file="$(arg sensor_sim_config)"/>
  </node>

  <!-- 传感器批量打包节点：将单个传感器消息打包成批量数据 -->
  <node pkg="mag_device_sensor" type="sensor_array_batcher_node" name="sensor_array_batcher" output="screen">
    <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
    <rosparam command="load" file="$(arg sensor_batcher_config)"/>
  </node>

  <!-- 姿态估计节点：估计磁体姿态 -->
  <node pkg="mag_pose_estimator" type="mag_pose_estimator_node" name="mag_pose_estimator" output="screen">
    <!-- 方式1：通过环境变量设置日志级别（全局，优先级较低） -->
    <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
    <!-- 方式2：通过rosparam设置日志级别（节点级别，优先级更高，会覆盖YAML配置） -->
    <!-- <rosparam param="logging_level">DEBUG</rosparam> -->
    <rosparam command="load" file="$(arg estimator_config)"/>
  </node>

  <!-- 跟踪控制节点：根据磁体位姿估计结果自动控制机械臂跟踪 -->
  <group if="$(arg enable_tracking_control)">
    <!-- 加载配置文件到节点命名空间 -->
    <rosparam file="$(arg tracking_control_config)" command="load" ns="tracking_control_node"/>
    <!-- 覆盖 enable_execution 参数 -->
    <param name="tracking_control_node/config/control/enable_execution" value="$(arg enable_execution)"/>
    <!-- 启动跟踪控制节点 -->
    <node name="tracking_control_node" pkg="mag_tracking_control" type="tracking_control_node" output="screen">
      <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
    </node>
  </group>

  <!-- 可视化节点：展示真值和估计结果 -->
  <node pkg="mag_viz" type="magnet_viz_node" name="magnet_viz" output="screen">
    <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
    <rosparam command="load" file="$(arg magnet_viz_config)"/>
  </node>

  <!-- 传感器阵列可视化节点 -->
  <node pkg="mag_viz" type="sensor_array_viz_node" name="sensor_array_viz" output="screen">
    <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
    <rosparam command="load" file="$(arg sensor_array_viz_config)"/>
    <rosparam command="load" file="$(arg sensor_array_config)" ns="array"/>
  </node>

  <!-- RViz 可视化 -->
  <group if="$(arg use_rviz)">
    <!-- 将 rviz 输出重定向到 log，不在终端显示 -->
    <node pkg="rviz" type="rviz" name="magnet_viz_rviz" 
          args="-d $(find mag_single_tracking_app)/rviz/magnet_viz.rviz" output="log">
      <!-- 设置 rviz 相关日志级别为 WARN，过滤 INFO 信息 -->
      <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
    </node>
  </group>
</launch>

