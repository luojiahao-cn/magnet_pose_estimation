<?xml version="1.0"?>
<launch>
  <!-- 设置日志级别为 WARN，减少终端输出 -->
  <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
  
  <!-- 工具参数 -->
  <arg name="tool_name" default="magnetic_sensor_bracket" doc="工具名称，如：magnetic_sensor_bracket, permanent_magnet, electronic_magnet, none"/>
  
  <!-- MoveIt 选项 -->
  <arg name="pipeline" default="ompl" doc="MoveIt 规划管道"/>
  <arg name="move_group_output" default="screen" doc="move_group 节点输出类型 (screen/log)"/>
  <arg name="use_rviz" default="true" doc="是否启动 RViz 可视化"/>
  <arg name="rviz_config" default="$(find mag_device_arm)/rviz/magnet_viz.rviz" doc="RViz 配置文件路径（可选）"/>

  <!-- Gazebo 选项 -->
  <arg name="gazebo_gui" default="true" doc="启动 Gazebo GUI"/>
  <arg name="paused" default="false" doc="启动 Gazebo 时暂停"/>
  <arg name="world_name" default="worlds/empty.world" doc="Gazebo 世界文件"/>
  <arg name="world_pose" default="-x 0 -y 0 -z 0 -R 0 -P 0 -Y 0" doc="机器人在世界中的初始位姿"/>
  <arg name="initial_joint_positions" default=" -J frrobot_j1 0 -J frrobot_j2 0 -J frrobot_j3 0 -J frrobot_j4 0 -J frrobot_j5 0 -J frrobot_j6 0" doc="机器人初始关节配置"/>

  <!-- ========== Gazebo 部分 ========== -->
  
  <!-- 为 Gazebo 相关节点设置日志级别 -->
  <group>
    <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
    <!-- 启动 Gazebo（先暂停，以便控制器能够获取初始姿态） -->
    <include file="$(find gazebo_ros)/launch/empty_world.launch">
      <arg name="paused" value="true"/>
      <arg name="gui" value="$(arg gazebo_gui)"/>
      <arg name="world_name" value="$(arg world_name)"/>
    </include>
  </group>

  <!-- 使用 xacro 加载机器人 URDF（带工具参数）到参数服务器 -->
  <param name="robot_description" 
         command="$(find xacro)/xacro $(find frcobot_description)/urdf/fr5v6_single_arm.xacro tool_name:=$(arg tool_name)"/>

  <!-- 如果未暂停，则取消暂停 -->
  <arg name="unpause" value="$(eval '' if arg('paused') else '-unpause')" />

  <!-- 在 Gazebo 中生成机器人模型 -->
  <node name="spawn_gazebo_model" pkg="gazebo_ros" type="spawn_model" 
        args="-urdf -param robot_description -model robot $(arg unpause) $(arg world_pose) $(arg initial_joint_positions)"
        respawn="false" output="log">
    <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
  </node>

  <!-- 加载控制器参数到参数服务器 -->
  <rosparam file="$(find fr5v6_single_moveit_config)/config/gazebo_controllers.yaml" />
  
  <!-- 加载 ros_controllers 配置并启动控制器 -->
  <rosparam file="$(find fr5v6_single_moveit_config)/config/ros_controllers.yaml" command="load"/>
  <node name="controller_spawner" pkg="controller_manager" type="spawner" respawn="false"
        output="log" args="fr5v6_arm_controller">
    <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
  </node>

  <!-- 启动 joint_state_controller -->
  <node name="gazebo_controller_spawner" pkg="controller_manager" type="spawner" respawn="false" 
        output="log" args="joint_state_controller">
    <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
  </node>

  <!-- 根据发布的关节状态，发布机器人链接的 TF -->
  <node name="robot_state_publisher" pkg="robot_state_publisher" type="robot_state_publisher" 
        respawn="true" output="screen">
    <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
  </node>
  
  <param name="use_sim_time" value="true"/>

  <!-- ========== MoveIt 部分 ========== -->
  
  <!-- 加载语义描述（SRDF） -->
  <param name="robot_description_semantic" textfile="$(find fr5v6_single_moveit_config)/config/fr5v6_single_arm.srdf" />

  <!-- 加载关节限制（覆盖 URDF 中的信息） -->
  <group ns="robot_description_planning">
    <rosparam command="load" file="$(find fr5v6_single_moveit_config)/config/joint_limits.yaml"/>
    <rosparam command="load" file="$(find fr5v6_single_moveit_config)/config/cartesian_limits.yaml"/>
  </group>

  <!-- 加载运动学默认设置 -->
  <group ns="robot_description_kinematics">
    <rosparam command="load" file="$(find fr5v6_single_moveit_config)/config/kinematics.yaml"/>
  </group>

  <!-- 规划管道配置 -->
  <group ns="move_group/planning_pipelines">
    <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
    <!-- OMPL -->
    <include file="$(find fr5v6_single_moveit_config)/launch/planning_pipeline.launch.xml">
      <arg name="pipeline" value="ompl" />
    </include>
    <!-- CHOMP -->
    <include file="$(find fr5v6_single_moveit_config)/launch/planning_pipeline.launch.xml">
      <arg name="pipeline" value="chomp" />
    </include>
    <!-- Pilz Industrial Motion -->
    <include file="$(find fr5v6_single_moveit_config)/launch/planning_pipeline.launch.xml">
      <arg name="pipeline" value="pilz_industrial_motion_planner" />
    </include>
    <!-- 支持自定义规划管道 -->
    <include if="$(eval arg('pipeline') not in ['ompl', 'chomp', 'pilz_industrial_motion_planner'])"
             file="$(find fr5v6_single_moveit_config)/launch/planning_pipeline.launch.xml">
      <arg name="pipeline" value="$(arg pipeline)" />
    </include>
  </group>

  <!-- 轨迹执行功能 -->
  <group ns="move_group">
    <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
    <include file="$(find fr5v6_single_moveit_config)/launch/trajectory_execution.launch.xml">
      <arg name="moveit_manage_controllers" value="true" />
      <arg name="moveit_controller_manager" value="ros_control" />
    </include>
  </group>


  <!-- 启动 move_group 节点/动作服务器 -->
  <node name="move_group" pkg="moveit_ros_move_group" type="move_group" respawn="false" 
        output="log">
    <env name="DISPLAY" value="$(optenv DISPLAY :0)" />
    <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN" />
    <param name="allow_trajectory_execution" value="true"/>
    <param name="sense_for_plan/max_safe_path_cost" value="1"/>
    <param name="default_planning_pipeline" value="$(arg pipeline)" />
    <param name="capabilities" value="" />
    <param name="disable_capabilities" value="" />
    <param name="monitor_dynamics" value="false" />
    <param name="planning_scene_monitor/publish_planning_scene" value="true" />
    <param name="planning_scene_monitor/publish_geometry_updates" value="true" />
    <param name="planning_scene_monitor/publish_state_updates" value="true" />
    <param name="planning_scene_monitor/publish_transforms_updates" value="true" />
    <param name="planning_scene_monitor/octomap_resolution" value="0.1" />
  </node>

  <!-- ========== RViz 可视化（可选） ========== -->
  <group if="$(arg use_rviz)">
    <arg if="$(eval rviz_config != '')" name="rviz_command_args" value="-d $(arg rviz_config)"/>
    <arg unless="$(eval rviz_config != '')" name="rviz_command_args" value=""/>
    <node name="moveit_rviz" pkg="rviz" type="rviz" respawn="false" output="log"
          args="$(arg rviz_command_args)">
      <env name="ROSCONSOLE_MIN_SEVERITY" value="WARN"/>
    </node>
  </group>

</launch>
