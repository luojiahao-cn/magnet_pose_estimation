# 磁铁姿态估计器节点配置文件
# 该文件定义了磁铁姿态估计算法的所有配置参数
config:
  # 坐标系配置
  frames:
    output_frame: sensor_array
    magnet_frame: magnet_estimated
    enable_tf: true

  # 话题配置
  topics:
    mag_field: /magnetic/sensor/field  # 单个磁传感器测量数据输入话题（EKF 模式使用）
    mag_batch: /magnetic/sensor/batch  # 批量传感器数据输入话题（优先使用）
    pose_estimate: /magnetic/pose_estimated  # 姿态估计结果输出话题

  # 参数配置
  params:
    # 估计器配置
    estimator:
      type: optimizer  # 估计器类型（"ekf" 或 "optimizer"）
      tf_timeout: 0.05  # TF变换查询超时时间（秒）

    # EKF 估计器参数（仅当 type: "ekf" 时使用）
    ekf:
      position_gain: 0.02  # 位置增益系数
      process_noise_position: 1.0e-4  # 位置过程噪声方差
      process_noise_orientation: 5.0e-5  # 姿态过程噪声方差
      measurement_noise: 1.0e-3  # 测量噪声方差
      world_field: [0.02, 0.01, 0.045]  # 地球磁场向量 [x, y, z] (mT，毫特斯拉)

    # 预处理器参数
    preprocessor:
      enable_calibration: false  # 是否启用磁传感器校准
      soft_iron_matrix: [1.02, 0.00, 0.00,  # 软铁校准矩阵 (3x3)
                         0.00, 0.99, 0.01,
                         0.00, 0.01, 1.01]
      hard_iron_offset: [1.0, -2.0, 0.5]  # 硬铁偏移向量 [x, y, z] (mT，毫特斯拉)
      enable_filter: false  # 是否启用低通滤波器
      low_pass_alpha: 0.2  # 低通滤波器alpha系数 (0-1, 越大越平滑)

    # 优化器参数（仅当 type: "optimizer" 时使用）
    optimizer:
      min_sensors: 6  # 最小有效传感器数量
      initial_position: [0.0, 0.0, 0.8]  # 初始位置估计 [x, y, z] (米)
      initial_direction: [0.0, 0.0, 1.0]  # 初始磁矩方向向量 [x, y, z]
      initial_strength: 10  # 初始磁矩强度 (Ampere*meter^2)
      strength_delta: 5.0  # 磁矩强度搜索范围 (±delta)，建议为初始强度的 50% 左右
      optimize_strength: true  # 是否优化磁矩强度
      max_iterations: 60  # 最大迭代次数
      function_tolerance: 1.0e-6  # 函数值收敛容差（LM 算法，过严格可能导致不收敛）
      gradient_tolerance: 1.0e-8  # 梯度收敛容差（LM 算法）
      parameter_tolerance: 1.0e-8  # 参数收敛容差（LM 算法）
      num_threads: 2  # 并行计算线程数
      minimizer_progress: false  # 是否显示优化器进度信息
      linear_solver: DENSE_QR  # 线性求解器类型
      max_acceptable_residual: 1.0  # 可接受的最大平均残差 (mT)，超过此值即使优化收敛也认为失败
