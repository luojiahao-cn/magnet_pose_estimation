# 磁铁位姿估计系统流程说明

## 系统架构概览

整个系统由以下几个主要模块组成：

1. **磁铁仿真节点** (`mag_device_magnet`) - 生成磁铁的真实位姿和 TF 变换
2. **传感器仿真节点** (`mag_device_sensor`) - 根据磁铁位姿计算磁场并发布传感器数据
3. **位姿估计节点** (`mag_pose_estimator`) - 接收传感器数据，估计磁铁位姿
4. **可视化节点** (`mag_viz`) - 可视化真实和估计的位姿

---

## 完整数据流程

### 阶段 1: 磁铁位姿生成（磁铁节点）

**节点**: `mag_device_magnet::MagnetNode`

1. **轨迹采样**
   - 根据配置的轨迹类型（静态/圆形/矩形）计算磁铁位置
   - 根据配置的姿态模式（固定/旋转）计算磁铁姿态
   - 生成 `geometry_msgs::Pose` 消息

2. **TF 发布**
   - 发布 `world -> magnet` 的 TF 变换
   - 频率：30 Hz（可配置）

3. **位姿发布**
   - 发布 `/magnetic/pose_true` 话题（`mag_core_msgs::MagnetPose`）
   - 包含：位置、姿态、磁矩强度（10.0 Am²）

---

### 阶段 2: 磁场数据生成（传感器仿真节点）

**节点**: `mag_device_sensor::SensorSimNode`

1. **TF 监听**
   - 监听 `world -> magnet` 的 TF 变换
   - 获取磁铁的位置和姿态

2. **传感器位置计算**
   - 从传感器阵列描述中获取每个传感器在 `sensor_array` 坐标系下的位置
   - 通过 TF 转换到 `world` 坐标系

3. **磁场计算（磁偶极子模型）**
   ```
   对于每个传感器 i:
     - 计算相对位置向量: r = sensor_position - magnet_position
     - 计算磁矩向量: m = dipole_strength * magnet_direction
     - 使用磁偶极子公式计算磁场:
       B = (μ₀/4π) * [3(m·r)r/r⁵ - m/r³] * 1000  (转换为 mT)
   ```

4. **噪声添加**（可选）
   - 如果启用噪声，添加高斯噪声到磁场数据

5. **数据发布**
   - 发布 `/magnetic/sensor/field` 话题（`mag_core_msgs::MagSensorData`）
   - 每个传感器独立发布一条消息
   - 包含：传感器 ID、时间戳、坐标系、磁场向量 (mT)
   - 频率：100 Hz（可配置）

---

### 阶段 3: 数据预处理（位姿估计节点）

**节点**: `mag_pose_estimator::MagPoseEstimatorNode`

1. **订阅传感器数据**
   - 订阅 `/magnetic/sensor/field` 话题
   - 回调函数：`magCallback()`

2. **消息转换**
   - 将 `mag_core_msgs::MagSensorData` 转换为 `sensor_msgs::MagneticField`
   - 保持单位：mT（毫特斯拉）

3. **数据预处理** (`MagPreprocessor`)
   - **软铁校准**（可选）：
     - 应用 3×3 软铁校准矩阵：`B_calibrated = M_soft_iron * B_raw`
   - **硬铁校准**（可选）：
     - 减去硬铁偏移：`B_calibrated = B_raw - B_hard_iron`
   - **低通滤波**（可选）：
     - 一阶低通滤波器：`B_filtered = α * B_new + (1-α) * B_old`
     - α 系数：0.0-1.0（越大越平滑）

---

### 阶段 4: 位姿估计（优化器模式）

**节点**: `mag_pose_estimator::MagPoseEstimatorNode` + `OptimizerEstimator`

#### 4.1 数据缓存

1. **缓存测量数据** (`cacheMeasurement`)
   - 每个传感器只保留最新一次读数
   - 存储：时间戳、坐标系、磁场向量 (mT)
   - 使用传感器 ID 作为键值

2. **检查传感器数量**
   - 如果缓存中的传感器数量 < `min_sensors`（默认 6），等待更多数据
   - 否则，继续下一步

#### 4.2 批量数据构建

1. **构建批量数据** (`buildBatch`)
   - 遍历所有缓存的测量数据
   - 对于每个传感器：
     - **TF 查询** (`fillOptimizerMeasurement`)：
       - 查询 `sensor_frame -> output_frame` 的 TF 变换（使用数据的时间戳）
       - 获取传感器在 `output_frame` 下的位置
       - 将磁场向量从传感器坐标系转换到 `output_frame` 坐标系
     - 构建 `OptimizerMeasurement` 结构：
       - `sensor_id`: 传感器 ID
       - `sensor_position`: 传感器位置 (米)
       - `magnetic_field`: 磁场向量 (mT，已转换到统一坐标系)
   - 记录批量数据中的最新时间戳

2. **验证数据有效性**
   - 如果 TF 查询失败，移除该传感器的缓存数据
   - 确保有效传感器数量 >= `min_sensors`

#### 4.3 Ceres 优化器求解

1. **初始化优化变量** (`estimateFromBatch`)
   - `position[3]`: 磁铁位置 [x, y, z] (米) - 使用上次估计值或初始值
   - `direction[3]`: 磁矩方向向量 [x, y, z]（归一化）- 使用上次估计值或初始值
   - `strength`: 磁矩强度 (Am²) - 使用上次估计值或初始值（如果 `optimize_strength=true`）

2. **构建优化问题**
   - 对于每个传感器测量：
     - 创建残差函数（基于磁偶极子模型）：
       ```
       residual = predicted_field - measured_field
       predicted_field = dipole_model(sensor_position, magnet_position, magnet_direction, magnet_strength)
       ```
     - 添加到 Ceres 优化问题：
       - 如果优化强度：`AddResidualBlock(cost, nullptr, position, direction, &strength)`
       - 如果固定强度：`AddResidualBlock(cost, nullptr, position, direction)`

3. **设置约束**
   - 方向向量归一化约束：`SetParameterization(direction, HomogeneousVectorParameterization)`
   - 强度上下界（如果优化强度）：
     - 下界：`initial_strength - strength_delta`
     - 上界：`initial_strength + strength_delta`

4. **配置求解器选项**
   - 线性求解器：`DENSE_QR`（可配置）
   - 信任域策略：`LEVENBERG_MARQUARDT`
   - 最大迭代次数：60（可配置）
   - 收敛容差：
     - `function_tolerance`: 1.0e-6
     - `gradient_tolerance`: 1.0e-8
     - `parameter_tolerance`: 1.0e-8
   - 线程数：2（可配置）

5. **执行优化** (`ceres::Solve`)
   - Ceres 优化器迭代求解
   - 最小化所有传感器的残差平方和

6. **更新内部状态**
   - 将优化后的位置、方向、强度写回估计器内部状态
   - 从方向向量计算姿态四元数：
     ```cpp
     orientation = Quaterniond::FromTwoVectors(UnitZ(), magnet_direction)
     ```

7. **构建输出姿态**
   - 创建 `geometry_msgs::Pose` 消息
   - 包含：位置（优化后的 position）、姿态（从方向向量计算）

#### 4.4 结果发布

1. **发布估计结果** (`publishPose`)
   - 发布 `/magnetic/pose_estimated` 话题（`mag_core_msgs::MagnetPose`）
   - 包含：
     - `header.stamp`: 批量数据的最新时间戳（减少滞后）
     - `header.frame_id`: `output_frame`（默认 `sensor_array`）
     - `position`: 估计的位置 [x, y, z] (米)
     - `orientation`: 估计的姿态四元数
     - `magnetic_strength`: 估计的磁矩强度 (Am²)

2. **清空缓存**
   - 优化成功后，清空测量缓存
   - 准备接收下一批传感器数据

---

### 阶段 5: 可视化（可视化节点）

**节点**: `mag_viz::MagnetVizNode`

1. **订阅位姿数据**
   - 订阅 `/magnetic/pose_true` - 真实位姿
   - 订阅 `/magnetic/pose_estimated` - 估计位姿

2. **可视化标记**
   - 为每个位姿创建可视化标记：
     - 磁铁圆柱体（表示磁铁方向和位置）
     - 轨迹线（显示运动轨迹）
     - 磁矩强度文本（显示磁矩强度值）

3. **发布可视化数据**
   - 发布 `visualization_msgs::MarkerArray` 到 `/magnetic/viz/markers`
   - 发布 `nav_msgs::Path` 到 `/magnetic/viz/trajectory`

---

## 关键参数说明

### 优化器参数（`estimator_config.yaml`）

- `min_sensors: 6` - 批量优化所需的最小传感器数量
- `tf_timeout: 0.1` - TF 查询超时时间（秒）
- `max_iterations: 60` - 最大迭代次数
- `function_tolerance: 1.0e-6` - 函数值收敛容差
- `gradient_tolerance: 1.0e-8` - 梯度收敛容差
- `parameter_tolerance: 1.0e-8` - 参数收敛容差
- `initial_position: [0.0, 0.0, 0.8]` - 初始位置估计
- `initial_strength: 1.5` - 初始磁矩强度 (Am²)
- `optimize_strength: true` - 是否优化磁矩强度

### 传感器参数（`sensor_sim_config.yaml`）

- `update_rate_hz: 100.0` - 传感器数据发布频率
- `dipole_strength: 10.0` - 磁铁磁矩强度 (Am²)
- `noise.enable: false` - 是否启用噪声

---

## 数据流图

```
磁铁节点 (MagnetNode)
    │
    ├─> 发布 TF: world -> magnet (30 Hz)
    │
    └─> 发布位姿: /magnetic/pose_true
        │
        └─> 可视化节点 (MagnetVizNode)
            └─> 显示真实位姿

传感器仿真节点 (SensorSimNode)
    │
    ├─> 监听 TF: world -> magnet
    │
    ├─> 计算磁场（磁偶极子模型）
    │
    └─> 发布数据: /magnetic/sensor/field (100 Hz)
        │
        └─> 位姿估计节点 (MagPoseEstimatorNode)
            │
            ├─> 数据预处理 (MagPreprocessor)
            │   ├─> 软铁校准（可选）
            │   ├─> 硬铁校准（可选）
            │   └─> 低通滤波（可选）
            │
            ├─> 数据缓存 (cacheMeasurement)
            │   └─> 等待足够传感器数量 (min_sensors)
            │
            ├─> 批量数据构建 (buildBatch)
            │   ├─> TF 查询传感器位置
            │   └─> 坐标系转换
            │
            ├─> Ceres 优化器 (OptimizerEstimator)
            │   ├─> 构建优化问题
            │   ├─> 设置约束
            │   └─> 迭代求解
            │
            └─> 发布结果: /magnetic/pose_estimated
                │
                └─> 可视化节点 (MagnetVizNode)
                    └─> 显示估计位姿
```

---

## 时间同步说明

1. **传感器数据时间戳**
   - 每个传感器数据都带有时间戳（来自传感器仿真节点）
   - 时间戳用于 TF 查询，确保使用正确的传感器位置

2. **批量数据时间戳**
   - 批量优化器使用批量数据中的最新时间戳作为发布结果的时间戳
   - 这减少了因使用 `ros::Time::now()` 导致的滞后

3. **TF 查询时间戳**
   - 使用传感器数据的时间戳查询 TF 变换
   - 确保传感器位置与测量数据时间一致

---

## 坐标系说明

- `world`: 世界坐标系（固定）
- `magnet`: 磁铁坐标系（随磁铁运动）
- `sensor_array`: 传感器阵列坐标系（固定）
- `sensor_i`: 第 i 个传感器的坐标系（相对于 sensor_array）

所有传感器数据最终转换到 `sensor_array` 坐标系进行优化。

---

## 优化模型

### 磁偶极子模型

磁铁在位置 `r` 处产生的磁场：

```
B = (μ₀/4π) * [3(m·r̂)r̂ - m] / r³
```

其中：
- `m = strength * direction` - 磁矩向量 (Am²)
- `r = sensor_position - magnet_position` - 相对位置向量 (米)
- `r̂ = r / |r|` - 归一化方向向量
- `μ₀/4π = 1e-7` (H/m) - 真空磁导率常数
- 单位转换：乘以 1000 转换为 mT

### 残差函数

对于每个传感器 i：

```
residual_i = B_predicted_i - B_measured_i
```

优化目标：最小化所有传感器的残差平方和：

```
cost = Σᵢ |residual_i|²
```

---

## 性能优化建议

1. **减少滞后**：
   - ✅ 使用批量数据的最新时间戳（已实现）
   - ✅ 增加 TF 查询超时时间（已实现）

2. **提高精度**：
   - ✅ 放宽收敛容差（已实现）
   - 增加最大迭代次数（如果收敛慢）
   - 调整初始位置估计（接近真实位置）

3. **提高稳定性**：
   - 启用低通滤波器（平滑噪声）
   - 启用传感器校准（如果存在系统误差）

