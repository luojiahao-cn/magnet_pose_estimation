# 磁铁姿态估计与机械臂跟踪系统项目文档

## 项目概述

本项目旨在实现一个基于磁场检测的机械臂跟踪系统。系统使用两个协作机械臂：一个机械臂（传感器臂）上安装磁传感器阵列，用于实时检测磁场强度和方向；另一个机械臂（磁铁臂）上放置磁铁作为跟踪目标。通过磁场数据采集、姿态估计算法和运动控制，实现磁铁臂对传感器臂的精确跟踪，确保磁铁始终位于传感器阵列的有效检测范围内。

### 主要目标
- **实时姿态估计**：基于多传感器磁场数据，准确估计磁铁在三维空间中的位置和姿态。
- **协同跟踪控制**：通过ROS和MoveIt实现两个机械臂的协同运动，磁铁臂跟随传感器臂移动。
- **模块化设计**：系统采用ROS框架，模块化设计，便于扩展和维护。
- **统一通信**：所有位置和姿态信息通过TF（Transform）树发布，避免topic和TF的重复和混乱。

### 应用场景
- 工业自动化：磁铁定位和跟踪。
- 机器人研究：多机器人协同任务。
- 传感器校准：磁场环境下的姿态验证。

## 系统架构

### 硬件组件
- **机械臂1（传感器臂）**：
  - 安装磁传感器阵列（多个霍尔传感器）。
  - 负责采集磁场数据。
- **机械臂2（磁铁臂）**：
  - 末端安装磁铁。
  - 作为跟踪目标，通过运动控制保持在传感器检测范围内。
- **传感器阵列**：
  - 由多个磁传感器组成，形成阵列以提高检测精度。
- **计算平台**：
  - ROS兼容的计算机，用于运行控制算法和数据处理。

### 软件架构
系统基于ROS (Robot Operating System) 构建，采用分布式节点架构。核心组件包括：

- **传感器节点** (`mag_sensor_node`)：采集和发布磁场数据。
- **姿态估计节点** (`mag_pose_estimation`)：基于磁场数据计算磁铁姿态。
- **跟踪控制节点** (`mag_tracking_control`)：计算并执行跟踪运动。
- **可视化节点** (`mag_viz`)：提供实时可视化界面。
- **启动管理** (`mag_bringup`)：系统集成和launch文件。

### 数据流
1. **数据采集**：传感器阵列采集磁场数据，发布到ROS topic。
2. **姿态估计**：姿态估计器订阅磁场数据，使用优化或卡尔曼滤波算法计算磁铁姿态，通过TF发布。
3. **跟踪控制**：跟踪控制器订阅TF中的姿态信息，计算目标运动，通过MoveIt action发送控制命令。
4. **运动执行**：机械臂接收命令，执行跟踪运动。
5. **反馈循环**：实时更新姿态，持续跟踪。

## ROS包结构

### 现有包
- `mag_sensor_node`：传感器数据采集和TF发布。
- `mag_pose_estimation`：磁铁姿态估计。
- `mag_viz`：可视化和数据记录。
- `mag_bringup`：系统启动配置。
- `mag_arm_scan`：机械臂扫描控制（可复用于跟踪）。

### 新建/修改包
- `mag_tracking_control`：跟踪控制逻辑。
- `magnet_msgs`：统一消息和action定义。
- 修改`mag_sensor_node`和`mag_pose_estimation`：移除topic中的位置信息，统一使用TF。

### 包依赖
- 核心依赖：`roscpp`, `tf2`, `geometry_msgs`, `std_msgs`。
- 控制依赖：`moveit_msgs`, `actionlib`。
- 可视化依赖：`rviz`, `sensor_msgs`。

## 接口定义

### TF树结构
- **静态TF**：
  - `world` → `sensor_arm_base` → `sensor_array_frame` → `sensor_1`, `sensor_2`, ...
- **动态TF**：
  - `sensor_array_frame` → `magnet_frame`（磁铁姿态）。
  - `world` → `magnet_arm_base` → `magnet_arm_ee`（磁铁臂姿态）。

### Topic通信
- `/mag_sensor_data` (`MagSensorData`)：磁场强度数据（x, y, z）。
- `/magnet_pose_error` (`std_msgs/Float64`)：估计误差。

### Action通信
- `TrackMagnet.action`：
  - **Goal**：启用跟踪，设置偏移参数。
  - **Feedback**：当前磁铁姿态。
  - **Result**：跟踪成功状态。

### Service通信
- `/reset_pose_estimation` (`std_srvs/Empty`)：重置估计器。

## 实现步骤

1. **需求分析与设计**：完成系统架构和接口设计。
2. **消息定义**：创建和修改ROS消息、action。
3. **传感器节点修改**：移除位置信息，依赖TF。
4. **姿态估计修改**：添加TF发布，移除topic发布。
5. **跟踪控制实现**：编写控制器节点，集成MoveIt。
6. **系统集成**：更新launch文件，配置参数。
7. **测试与验证**：单元测试、集成测试、硬件测试。
8. **文档与维护**：编写用户手册，维护代码。

## 测试计划

- **单元测试**：各节点功能测试。
- **集成测试**：数据流验证，TF树完整性。
- **硬件测试**：实际机械臂跟踪测试。
- **性能测试**：实时性、精度评估。

## 风险与挑战

- **磁场干扰**：环境磁场影响精度。
- **实时性**：确保控制循环满足机械臂要求。
- **校准**：传感器和磁铁参数准确性。

## 团队与时间线

- **开发团队**：ROS开发者、控制工程师。
- **时间线**：预计3-6个月，视硬件可用性而定。

---

本文档为项目整体规划，具体实现请参考各包的README和代码注释。如有疑问，请联系项目维护者。